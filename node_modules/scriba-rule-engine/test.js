const assert = require('assert');
const { RuleEngine } = require('./dist/index');
const { defaultActions } = require('./dist/actions');
const { defaultConditions } = require('./dist/conditions');

class TestSuite {
    constructor() {
        this.passed = 0;
        this.failed = 0;
    }

    async run(name, fn) {
        try {
            await fn();
            console.log(`✅ ${name}`);
            this.passed++;
        } catch (err) {
            console.error(`❌ ${name}`);
            console.error('   ', err.message);
            this.failed++;
        }
    }

    summary() {
        console.log(`\n=== SUMMARY ===`);
        console.log(`Passed: ${this.passed}`);
        console.log(`Failed: ${this.failed}`);
    }
}

(async () => {
    const suite = new TestSuite();
    const engine = new RuleEngine({
        conditions: defaultConditions,
        actions: defaultActions,
    });

    // ----------------------
    // CONDITIONS TESTS
    // ----------------------
    await suite.run('greaterThan', async () => {
        assert.strictEqual(defaultConditions.greaterThan({ a: 5 }, { field: 'a', value: 2 }), true);
        assert.strictEqual(defaultConditions.greaterThan({ a: 1 }, { field: 'a', value: 2 }), false);
        assert.strictEqual(defaultConditions.greaterThan({ a: 2 }, { field: 'a', value: 2 }), false);
    });

    await suite.run('lessThan', async () => {
        assert.strictEqual(defaultConditions.lessThan({ a: 1 }, { field: 'a', value: 2 }), true);
        assert.strictEqual(defaultConditions.lessThan({ a: 3 }, { field: 'a', value: 2 }), false);
        assert.strictEqual(defaultConditions.lessThan({ a: 2 }, { field: 'a', value: 2 }), false);
    });

    await suite.run('equals', async () => {
        assert.strictEqual(defaultConditions.equals({ x: 'test' }, { field: 'x', value: 'test' }), true);
        assert.strictEqual(defaultConditions.equals({ x: 'fail' }, { field: 'x', value: 'test' }), false);
        assert.strictEqual(defaultConditions.equals({ y: 10 }, { field: 'y', value: 10 }), true);
    });

    await suite.run('notEquals', async () => {
        assert.strictEqual(defaultConditions.notEquals({ x: 5 }, { field: 'x', value: 3 }), true);
        assert.strictEqual(defaultConditions.notEquals({ x: 5 }, { field: 'x', value: 5 }), false);
    });

    await suite.run('fieldExists', async () => {
        assert.strictEqual(defaultConditions.fieldExists({ x: 1 }, { field: 'x' }), true);
        assert.strictEqual(defaultConditions.fieldExists({ x: undefined }, { field: 'x' }), false);
        assert.strictEqual(defaultConditions.fieldExists({}, { field: 'x' }), false);
    });

    await suite.run('fieldNull', async () => {
        assert.strictEqual(defaultConditions.fieldNull({ x: null }, { field: 'x' }), true);
        assert.strictEqual(defaultConditions.fieldNull({ x: 1 }, { field: 'x' }), false);
        assert.strictEqual(defaultConditions.fieldNull({}, { field: 'x' }), true);
    });

    await suite.run('expression', async () => {
        const record = { a: 5, b: 10 };
        assert.strictEqual(defaultConditions.expression(record, { expression: '{{a}} + {{b}} === 15' }), true);
        assert.strictEqual(defaultConditions.expression(record, { expression: '{{a}} * 3 === 15' }), true);
        assert.strictEqual(defaultConditions.expression(record, { expression: '{{b}} - {{a}} === 4' }), false);
    });

    await suite.run('inList', async () => {
        const record = { role: 'admin' };
        assert.strictEqual(defaultConditions.inList(record, { field: 'role', value: ['admin', 'user'] }), true);
        assert.strictEqual(defaultConditions.inList(record, { field: 'role', value: ['guest', 'moderator'] }), false);
    });

    await suite.run('notInList', async () => {
        const record = { country: 'US' };
        assert.strictEqual(defaultConditions.notInList(record, { field: 'country', value: ['BR', 'CA'] }), true);
        assert.strictEqual(defaultConditions.notInList(record, { field: 'country', value: ['US', 'MX'] }), false);
    });

    await suite.run('matchesRegex', async () => {
        const record = { email: 'user@example.com' };
        assert.strictEqual(defaultConditions.matchesRegex(record, { field: 'email', value: /^[\w.-]+@[\w.-]+\.\w+$/ }), true);
        assert.strictEqual(defaultConditions.matchesRegex(record, { field: 'email', value: /^test/ }), false);
    });

    // ----------------------
    // ACTIONS TESTS
    // ----------------------
    await suite.run('setField', async () => {
        const rec = { a: 1, nested: {}, x: 5 };
        await defaultActions.setField({ record: rec, payload: { field: 'a', value: 10 } });
        assert.strictEqual(rec.a, 10);
        await defaultActions.setField({ record: rec, payload: { field: 'nested.b', value: 20 } });
        assert.strictEqual(rec.nested.b, 20);
        await defaultActions.setField({ record: rec, payload: { field: 'y', expression: '{{x}} * 2' } });
        assert.strictEqual(rec.y, 10);
    });

    await suite.run('throw', async () => {
        try {
            await defaultActions.throw({ payload: { message: 'Error test' } });
            assert.fail('Should have thrown');
        } catch (err) {
            assert.strictEqual(err.message, 'Error test');
        }
    });

    await suite.run('log', async () => {
        await defaultActions.log({ payload: { message: 'Logging test' } });
    });

    await suite.run('callWebhook', async () => {
        global.fetch = async (url, opts) => {
            assert.strictEqual(url, 'https://fake.url');
            const body = JSON.parse(opts.body);
            assert.strictEqual(body.userId, 123);
            assert.strictEqual(body.userName, 'John');
            return { ok: true };
        };
        await defaultActions.callWebhook({
            record: { id: 123, name: 'John' },
            payload: { url: 'https://fake.url', payload: { userId: '{{id}}', userName: '{{name}}' } }
        });
    });

    await suite.run('callFunction', async () => {
        let rec = { value: 0 };
        await defaultActions.callFunction({
            record: rec,
            payload: { fn: (r, x, y) => { r.value = x + y }, args: [5, 10] }
        });
        assert.strictEqual(rec.value, 15);
    });

    // ----------------------
    // ENGINE TESTS COMBINED
    // ----------------------
    await suite.run('engine AND condition', async () => {
        const rec = { age: 30, status: 'inactive' };
        const rules = [
            {
                conditions: {
                    and: [
                        { type: 'greaterThan', field: 'age', value: 18 },
                        { not: { type: 'equals', field: 'status', value: 'active' } }
                    ]
                },
                actions: [
                    { type: 'setField', field: 'canAccess', value: true }
                ]
            }
        ];
        await engine.applyRules(rec, rules);
        assert.strictEqual(rec.canAccess, true);
    });

    await suite.run('engine OR condition', async () => {
        const rec = { age: 16, status: 'inactive' };
        const rules = [
            {
                conditions: {
                    or: [
                        { type: 'lessThan', field: 'age', value: 18 },
                        { type: 'equals', field: 'status', value: 'active' }
                    ]
                },
                actions: [
                    { type: 'setField', field: 'eligible', value: true }
                ]
            }
        ];
        await engine.applyRules(rec, rules);
        assert.strictEqual(rec.eligible, true);
    });

    await suite.run('engine nested expression', async () => {
        const rec = { score: 5 };
        const rules = [
            { conditions: { expression: '{{score}} > 0' }, actions: [{ type: 'setField', field: 'bonus', expression: '{{score}} * 10' }] }
        ];
        await engine.applyRules(rec, rules);
        assert.strictEqual(rec.bonus, 50);
    });

    await suite.run('engine multiple actions', async () => {
        const rec = { age: 70, status: 'active', profile: {} };
        const rules = [
            {
                conditions: { type: 'greaterThan', field: 'age', value: 65 },
                actions: [
                    { type: 'setField', field: 'status', value: 'blocked' },
                    { type: 'setField', field: 'profile.category', value: 'senior' }
                ]
            }
        ];
        await engine.applyRules(rec, rules);
        assert.strictEqual(rec.status, 'blocked');
        assert.strictEqual(rec.profile.category, 'senior');
    });

    await suite.run('engine callFunction', async () => {
        const rec = { counter: 1 };
        const rules = [
            {
                conditions: { type: 'greaterThan', field: 'counter', value: 0 },
                actions: [
                    { type: 'callFunction', fn: (r) => { r.counter += 10 }, args: [] }
                ]
            }
        ];
        await engine.applyRules(rec, rules);
        assert.strictEqual(rec.counter, 11);
    });

    suite.summary();
})();
